import{world,system,EntityEquippableComponent,EquipmentSlot,EnchantmentType,ItemStack,BlockInventoryComponent}from"@minecraft/server";import{addEffect,addDamage}from"./functions.js";import{despawn_and_save_items,restoreTrinketItems}from"./trinket.js";import{systemLevelReset}from"./system_level.js";export function itemsDamage(e,t,n,o,r){if(t&&"minecraft:player"==t.typeId&&e){const n=t.getComponent(EntityEquippableComponent.componentId),o=n?.getEquipment(EquipmentSlot.Head),r=n?.getEquipment(EquipmentSlot.Chest),i=n?.getEquipment(EquipmentSlot.Legs),a=n?.getEquipment(EquipmentSlot.Feet);o&&r&&i&&a&&(o.typeId.includes("_dragon_helmet")||r.typeId.includes("_dragon_chestplate")||i.typeId.includes("_dragon_leggings")||a.typeId.includes("_dragon_boots"))&&(t.hasTag("level_armor10")||e.applyDamage(2),t.addTag("dragon_armor_equip")),o||r||i||a||t.removeTag("dragon_armor_equip")}if(e&&"minecraft:player"==e.typeId){"entityAttack"==o&&e.hasTag("withering_necklace")&&addEffect(t,"wither",30,3,!0);const n=e.getComponent(EntityEquippableComponent.componentId),i=n?.getEquipment(EquipmentSlot.Mainhand);i&&("hfrlc:dragon_bone_dagger"==i.typeId&&Math.floor(100*Math.random())+1>50&&addDamage(t,Math.round(r),e),i.typeId.includes("ice_dragon_bone_")&&(addEffect(t,"wither",30,3,!0),"hfrlc:wyvern_fire"!=t.typeId&&"hfrlc:dragon_fire"!=t.typeId||addDamage(t,Math.round(r/2),e)),i.typeId.includes("fire_dragon_bone_")&&(t.setOnFire(5,!0),"hfrlc:wyvern_ice"!=t.typeId&&"hfrlc:dragon_ice"!=t.typeId||addDamage(t,Math.round(r/2),e)),"hfrlc:fire_sword"==i.typeId&&t.setOnFire(5,!0))}}export function Durability(e,t){system.run(()=>{const n=t.getComponent(EntityEquippableComponent.componentId),o=e.getComponent("durability");if(e&&void 0!==o)if(o.damage+4<o.maxDurability)o.damage=o.damage+4,n.setEquipment(EquipmentSlot.Mainhand,e);else if(o.damage+4>=o.maxDurability){const e=new ItemStack("minecraft:air");n.setEquipment(EquipmentSlot.Mainhand,e),t.playSound("random.break")}})}export function BreakBlock(e,t){system.run(()=>{const n=t.getComponent(EntityEquippableComponent.componentId),o=e.getComponent("durability");if(e&&void 0!==o)if(o.damage+2<o.maxDurability)o.damage=o.damage+2,n.setEquipment(EquipmentSlot.Mainhand,e);else if(o.damage+2>=o.maxDurability){const e=new ItemStack("minecraft:air");n.setEquipment(EquipmentSlot.Mainhand,e),t.playSound("random.break")}})}export function setToMaxDurability(e,t){const n=t?.getComponent("durability"),o=e.getComponent("equippable");if(n){const e=n.maxDurability,r=n.damage;n.damage=Math.max(0,r-(e-r)),o.setEquipment(EquipmentSlot.Mainhand,t)}}export function saveInventory(e){let t={};const n=e.getComponent("inventory").container,o=n.size;for(let e=0;e<o;e++){const o=n.getItem(e);if(!o)continue;let r={typeId:o.typeId,count:o.amount,lore:[],enchantments:[],keepOnDeath:!1,lockInInventory:"none"};const i=o.getLore();i.length>0&&(r.lore=i),1==o.keepOnDeath&&(r.keepOnDeath=!0),"inventory"==o.lockMode&&(r.lockInInventory="inventory");const a=o.getComponent("enchantable");if(a){const e=a.getEnchantments();e.length>0&&(r.enchantments=e.map(e=>({id:e.type.id,level:e.level})))}const c=o.nameTag;c&&(r.customName=c),t[`item_${e}`]=r}const r=["Head","Chest","Legs","Feet"],i=e.getComponent("equippable");for(const e of r){const n=i.getEquipmentSlot(e)?.getItem();if(!n)continue;let o={typeId:n.typeId,count:n.amount,lore:[],enchantments:[]};const r=n.getLore();r.length>0&&(o.lore=r);const a=n.getComponent("enchantable");if(a){const e=a.getEnchantments();e.length>0&&(o.enchantments=e.map(e=>({id:e.type.id,level:e.level})))}const c=n.nameTag;c&&(o.customName=c),t[`equipment_${e}`]=o,i.setEquipment(e,void 0)}const a=e.getTotalXp(),c=world.scoreboard.getObjective("thirst").getScore(e)??0,s=world.scoreboard.getObjective("thermometer").getScore(e)??0,l=world.scoreboard.getObjective("melee").getScore(e)??0,d=world.scoreboard.getObjective("mining").getScore(e)??0,m=world.scoreboard.getObjective("armor").getScore(e)??0,p=world.scoreboard.getObjective("agility").getScore(e)??0;t.XPL=a,t.thirstbar=c,t.thermometer=s,t.meleeLevel=l,t.miningLevel=d,t.armorLevel=m,t.agilityLevel=p;const g=despawn_and_save_items(e);t.trinkets=g;let y=JSON.stringify(t);world.setDynamicProperty(`hfrlc:savedInventory_${e.id}`,y),n.clearAll(),e.resetLevel(),systemLevelReset(e)}export function giveSavedInventory(e){const t=e.getComponent("inventory").container;t.clearAll();const n=world.getDynamicProperty(`hfrlc:savedInventory_${e.id}`);if(!n)return;const o=JSON.parse(n);for(const e in o)if(e.startsWith("item_")){const n=o[e],r=new ItemStack(n.typeId,n.count);if(n.lore&&n.lore.length>0&&r.setLore(n.lore),n.enchantments&&n.enchantments.length>0){const e=r.getComponent("enchantable");for(const t of n.enchantments)e.addEnchantment({type:new EnchantmentType(t.id),level:t.level})}n.customName&&(r.nameTag=n.customName),1==n.keepOnDeath&&(r.keepOnDeath=!0),"inventory"==n.lockInInventory&&(r.lockMode="inventory"),t.addItem(r)}const r=["Head","Chest","Legs","Feet"],i=e.getComponent("equippable");for(const e of r){const t=o[`equipment_${e}`];if(!t)continue;const n=new ItemStack(t.typeId,t.count);if(t.lore&&t.lore.length>0&&n.setLore(t.lore),t.enchantments&&t.enchantments.length>0){const e=n.getComponent("enchantable");for(const n of t.enchantments)e.addEnchantment({type:new EnchantmentType(n.id),level:n.level})}t.customName&&(n.nameTag=t.customName),i.setEquipment(e,n)}e.addExperience(o.XPL),world.scoreboard.getObjective("thirst").setScore(e,o.thirstbar),world.scoreboard.getObjective("thermometer").setScore(e,o.thermometer),world.scoreboard.getObjective("melee").setScore(e,o.meleeLevel),world.scoreboard.getObjective("mining").setScore(e,o.miningLevel),world.scoreboard.getObjective("armor").setScore(e,o.armorLevel),world.scoreboard.getObjective("agility").setScore(e,o.agilityLevel),e.setProperty("hfrlc:melee_unlock",o.meleeLevel),e.setProperty("hfrlc:mining_unlock",o.miningLevel),e.setProperty("hfrlc:armor_unlock",o.armorLevel),e.setProperty("hfrlc:agility_unlock",o.agilityLevel);const a=o.trinkets??[];restoreTrinketItems(e,JSON.stringify({trinkets:a})),world.setDynamicProperty(`hfrlc:savedInventory_${e.id}`,void 0),e.dimension.playSound("armor.equip_generic",e.location)}export function transferInventoryToChest(e,t){const n=e.dimension.getBlock(t);if(!n)return!1;if("minecraft:chest"!==n.typeId)try{n.setType("minecraft:chest")}catch(e){return!1}const o=n.getComponent(BlockInventoryComponent.componentId);if(!o)return!1;const r=o.container;r.clearAll();const i=e.getComponent("inventory").container,a=i.size;let c=0;for(let e=0;e<a;e++){const t=i.getItem(e);if(t)try{r.addItem(t)?c++:i.setItem(e,void 0)}catch(e){c++}}const s=["Head","Chest","Legs","Feet"],l=e.getComponent("equippable");for(const e of s){const t=l.getEquipmentSlot(e)?.getItem();if(t)try{r.addItem(t)?c++:l.setEquipment(e,void 0)}catch(e){c++}}let d={};const m=e.getTotalXp(),p=world.scoreboard.getObjective("thirst").getScore(e)??0,g=world.scoreboard.getObjective("thermometer").getScore(e)??0,y=world.scoreboard.getObjective("melee").getScore(e)??0,u=world.scoreboard.getObjective("mining").getScore(e)??0,h=world.scoreboard.getObjective("armor").getScore(e)??0,v=world.scoreboard.getObjective("agility").getScore(e)??0;d.XPL=m,d.thirstbar=p,d.thermometer=g,d.meleeLevel=y,d.miningLevel=u,d.armorLevel=h,d.agilityLevel=v;const f=despawn_and_save_items(e);d.trinkets=f,world.setDynamicProperty(`hfrlc:tutorialChestLoc_${e.id}`,JSON.stringify({x:t.x,y:t.y,z:t.z})),world.setDynamicProperty(`hfrlc:tutorialData_${e.id}`,JSON.stringify(d)),e.resetLevel(),systemLevelReset(e);let I=0;for(let e=0;e<a;e++)i.getItem(e)&&I++;let b=0;for(let e=0;e<r.size;e++)r.getItem(e)&&b++;return!(c>0)&&(0===I&&b>0)}export function restoreInventoryFromChest(e){const t=world.getDynamicProperty(`hfrlc:tutorialChestLoc_${e.id}`);if(!t)return void giveSavedInventory(e);const n=JSON.parse(t),o=e.dimension.getBlock(n);if(!o||"minecraft:chest"!==o.typeId)return void giveSavedInventory(e);const r=o.getComponent(BlockInventoryComponent.componentId);if(!r)return void giveSavedInventory(e);const i=r.container,a=e.getComponent("inventory").container;a.clearAll();for(let t=0;t<i.size;t++){const n=i.getItem(t);if(n)try{const o=e.getComponent("equippable");let r=!1,c=null;try{const e=n.getComponent("wearable");if(e){e.protection;n.typeId.includes("helmet")||n.typeId.includes("_cap")||n.typeId.includes("_hood")||n.typeId.includes("_hat")?(r=!0,c="Head"):n.typeId.includes("chestplate")||n.typeId.includes("_tunic")||n.typeId.includes("_robe")||n.typeId.includes("_shirt")?(r=!0,c="Chest"):n.typeId.includes("leggings")||n.typeId.includes("_pants")||n.typeId.includes("_legs")||n.typeId.includes("_trousers")?(r=!0,c="Legs"):(n.typeId.includes("boots")||n.typeId.includes("_shoes")||n.typeId.includes("_feet")||n.typeId.includes("_sandals"))&&(r=!0,c="Feet")}}catch(e){}if(!r){const e=n.typeId.includes("helmet")||n.typeId.includes("_cap")||n.typeId.includes("_hood"),t=n.typeId.includes("chestplate")||n.typeId.includes("_tunic")||n.typeId.includes("_robe"),o=n.typeId.includes("leggings")||n.typeId.includes("_pants")||n.typeId.includes("_legs"),i=n.typeId.includes("boots")||n.typeId.includes("_shoes")||n.typeId.includes("_feet");e?(r=!0,c="Head"):t?(r=!0,c="Chest"):o?(r=!0,c="Legs"):i&&(r=!0,c="Feet")}if(r&&c)o.setEquipment(c,n),i.setItem(t,void 0);else{a.addItem(n)?0:i.setItem(t,void 0)}}catch(e){0}}const c=world.getDynamicProperty(`hfrlc:tutorialData_${e.id}`);if(c){const t=JSON.parse(c);e.addExperience(t.XPL||0),world.scoreboard.getObjective("thirst").setScore(e,t.thirstbar||0),world.scoreboard.getObjective("thermometer").setScore(e,t.thermometer||0),world.scoreboard.getObjective("melee").setScore(e,t.meleeLevel||0),world.scoreboard.getObjective("mining").setScore(e,t.miningLevel||0),world.scoreboard.getObjective("armor").setScore(e,t.armorLevel||0),world.scoreboard.getObjective("agility").setScore(e,t.agilityLevel||0),e.setProperty("hfrlc:melee_unlock",t.meleeLevel||0),e.setProperty("hfrlc:mining_unlock",t.miningLevel||0),e.setProperty("hfrlc:armor_unlock",t.armorLevel||0),e.setProperty("hfrlc:agility_unlock",t.agilityLevel||0);const n=t.trinkets??[];restoreTrinketItems(e,JSON.stringify({trinkets:n}))}for(let e=0;e<a.size;e++)a.getItem(e)&&0;let s=0;for(let e=0;e<i.size;e++)i.getItem(e)&&s++;if(0===s)try{o.setType("minecraft:air")}catch(e){}world.setDynamicProperty(`hfrlc:tutorialChestLoc_${e.id}`,void 0),world.setDynamicProperty(`hfrlc:tutorialData_${e.id}`,void 0),e.dimension.playSound("armor.equip_generic",e.location)}