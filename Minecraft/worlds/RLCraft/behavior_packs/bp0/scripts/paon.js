import{EntityDamageCause,system,world,GameMode}from"@minecraft/server";import{secondsToTicks,randInt}from"./libs/utils";import{bVector3}from"./libs/better_vectors";import{KNOCKBACK_EXCLUDED_ENTITIES}from"./tree_spirit";export const DATA={id:"hfrlc:paon",states:{none:"none",preparing_attack:"preparing_attack",attacking:"attacking"},attack_types:{none:"none",peck_attack:"peck_attack",fly_attack:"fly_attack"},attack_data:{peck_attack:{},fly_attack:{radius:1.5,knockback:.25,knockback_up:.15,damage:4,delay:secondsToTicks(.79),duration_min:secondsToTicks(.25),duration_max:secondsToTicks(.5),fly_speed:.5,fly_interval:1,jump_up_strength:.75,gravity:-.5,stuck_failsafe_time:secondsToTicks(.5)}},intimidation:{distance:10},running_away:{distance:10}};export async function tick(t){if(!t.getProperty("hfrlc:dead")){if(t.getProperty("hfrlc:has_target")&&!t.getProperty("hfrlc:is_baby")){t.getProperty("hfrlc:player_nearby")&&!t.getProperty("hfrlc:dead")&&(t.setProperty("hfrlc:player_nearby",!1),t.triggerEvent("hfrlc:no_player_nearby"),t.triggerEvent("hfrlc:movement_on"),t.triggerEvent("hfrlc:choose_attack"),t.setProperty("hfrlc:rotation_locked",!1));let e=t.getDynamicProperty("hfrlc:target");if(e)e=world.getEntity(t.getDynamicProperty("hfrlc:target"));else{const r=await getTarget(t);r&&(e=r,t.setDynamicProperty("hfrlc:target",r.id))}if(t.getProperty("hfrlc:state")===DATA.states.preparing_attack){t.getProperty("hfrlc:attack_type")===DATA.attack_types.fly_attack&&system.runTimeout(()=>{t.triggerEvent("hfrlc:attack_start"),t.triggerEvent("hfrlc:invulnerable"),t.setProperty("hfrlc:rotation_locked",!0);let r=system.runInterval(()=>{if(!t||!t?.isValid()||t?.getProperty("hfrlc:dead"))return void system.clearRun(r);t.getProperty("hfrlc:has_target")&&void 0!==e&&e?.isValid()||endFlight(t,r,e),bVector3.fromVector3(t.getVelocity()).magnitude()<=.1?t.setProperty("hfrlc:fly_failsafe",t.getProperty("hfrlc:fly_failsafe")+1):t.setProperty("hfrlc:fly_failsafe",0),t.getProperty("hfrlc:fly_failsafe")>=DATA.attack_data.fly_attack.stuck_failsafe_time&&endFlight(t,r,e);let a=getDirection(e,t);a.setMagnitude(DATA.attack_data.fly_attack.fly_speed),t.setProperty("hfrlc:rotation",a.angles().theta),t.clearVelocity();let o=t.dimension.getBlockFromRay(t.location,a,{includeLiquidBlocks:!1,includePassableBlocks:!1,maxDistance:4});if(o&&o.block&&o.block.isValid()){let t=o.block.above();t&&t.isValid()&&(t.isAir||t.isLiquid||(a.y=DATA.attack_data.fly_attack.jump_up_strength))}let c=t.dimension.getBlockFromRay(t.location,{x:0,y:-1,z:0},{includeLiquidBlocks:!1,includePassableBlocks:!1,maxDistance:5});if(c&&c.block&&c.block.isValid()){let e=bVector3.fromVector3(c.block.location);e.y=Math.floor(e.y)+1;let r=bVector3.fromVector3(t.location);bVector3.distance(r,e)>=1&&(a.y=DATA.attack_data.fly_attack.gravity)}t.applyImpulse(a);const i=t.dimension.getEntities({location:t.location,excludeGameModes:[GameMode.creative,GameMode.spectator],maxDistance:DATA.attack_data.fly_attack.radius,excludeFamilies:["inanimate"],excludeTypes:[DATA.id,...KNOCKBACK_EXCLUDED_ENTITIES]});for(const e of i){let r=bVector3.fromVector3(e.location),a=bVector3.subtract(r,t.location);e.applyKnockback(a.x,a.z,DATA.attack_data.fly_attack.knockback,.25),e.applyDamage(DATA.attack_data.fly_attack.damage,{cause:EntityDamageCause.entityAttack,damagingEntity:t})}},DATA.attack_data.fly_attack.fly_interval),a=randInt(DATA.attack_data.fly_attack.duration_min,DATA.attack_data.fly_attack.duration_max);system.runTimeout(()=>{endFlight(t,r,e)},a)},DATA.attack_data.fly_attack.delay)}}else if(!t.getProperty("hfrlc:is_baby")){let e,r=0,a=1/0;for(const o of t.dimension.getEntities({type:"minecraft:player",location:t.location,maxDistance:32}))if(o.getGameMode()===GameMode.survival||o.getGameMode()===GameMode.adventure){let c=bVector3.fromVector3(o.location),i=bVector3.fromVector3(t.location),n=bVector3.distance(c,i);n<=DATA.intimidation.distance&&(r++,n<=a&&(a=n,e=o))}if(r>0&&!t.getProperty("hfrlc:player_nearby")?(t.setProperty("hfrlc:player_nearby",!0),t.triggerEvent("hfrlc:player_nearby"),t.triggerEvent("hfrlc:movement_off")):0===r&&t.getProperty("hfrlc:player_nearby")&&!t.getProperty("hfrlc:dead")&&(t.setProperty("hfrlc:player_nearby",!1),t.setProperty("hfrlc:rotation_locked",!1),t.setProperty("hfrlc:state",DATA.states.none),t.triggerEvent("hfrlc:no_player_nearby"),t.triggerEvent("hfrlc:movement_on")),e){let r=bVector3.fromVector3(e.location),a=bVector3.fromVector3(t.location),o=bVector3.subtract(r,a);t.setRotation({x:0,y:o.angles().theta}),t.setProperty("hfrlc:rotation",o.angles().theta),t.setProperty("hfrlc:rotation_locked",!0)}}if(t.getProperty("hfrlc:is_baby")){let e=t.getDynamicProperty("hfrlc:attacker");if(e){const r=world.getEntity(e);if(r&&r?.isValid()&&"minecraft:player"===r?.typeId){let e=bVector3.fromVector3(r.location),a=bVector3.fromVector3(t.location);(bVector3.distance(e,a)>=DATA.running_away.distance||r.getGameMode()===GameMode.creative||r.getGameMode()===GameMode.spectator)&&(t.setDynamicProperty("hfrlc:attacker",void 0),t.triggerEvent("hfrlc:baby_stop_running"))}else t.setDynamicProperty("hfrlc:attacker",void 0),t.triggerEvent("hfrlc:baby_stop_running")}}}}export function onEvent(t){t.entity.typeId===DATA.id&&("hfrlc:no_target"===t.eventId&&t.entity&&t.entity?.isValid()&&t.entity?.setDynamicProperty("hfrlc:target",void 0),"hfrlc:death"!==t.eventId||t.entity.getProperty("hfrlc:rotation_locked")||(t.entity.setProperty("hfrlc:rotation",t.entity.getRotation().y),t.entity.setProperty("hfrlc:rotation_locked",!0),t.entity.clearVelocity(),t.entity.triggerEvent("hfrlc:movement_off")))}export function onAttack(t){const{damagingEntity:e,hitEntity:r}=t;if(r.typeId===DATA.id&&"minecraft:player"===e.typeId){if(e.getGameMode()===GameMode.creative||e.getGameMode()===GameMode.spectator)return;r.getProperty("hfrlc:is_baby")&&(r.setDynamicProperty("hfrlc:attacker",e.id),r.triggerEvent("hfrlc:baby_start_running"))}}function endFlight(t,e,r){t.triggerEvent("hfrlc:vulnerable"),t.setProperty("hfrlc:state",DATA.states.none),t.setProperty("hfrlc:rotation_locked",!1),t?.clearVelocity(),system.clearRun(e)}function getTarget(t){let e=!1;if(void 0!==t&&t?.isValid())return new Promise(r=>{t.triggerEvent("hfrlc:get_target");const a=system.afterEvents.scriptEventReceive.subscribe(t=>{if("hfrlc:get_target"===t.id)return e=!0,system.afterEvents.scriptEventReceive.unsubscribe(a),void r(t.sourceEntity)});system.runTimeout(()=>{system.afterEvents.scriptEventReceive.unsubscribe(a),e||r(null)},20)})}function getDirection(t,e){let r=bVector3.fromVector3(t.location),a=bVector3.fromVector3(e.location);return bVector3.subtract(r,a)}